<div class="row" id="manage" style="margin-bottom:100px;">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-heading">       
        <div class="btn-group pull-right" style="height: 38px;margin-top:-8px;background-color: #ffffff; border-left: 1px solid #dddddd;border-top: 1px solid #dddddd;border-right: 1px solid #dddddd;border-bottom: 1px solid #ffffff;">
          <span class="btn btn-sm dropdown-toggle" data-toggle="dropdown">
            <i class="fa fa-calendar"></i><span class="hidden-xs" style="font-size: 14px;"> Periode Rawat</span>
          </span>
          <ul class="dropdown-menu dropdown-menu-right">
            <li style="padding-left:5px;padding-right:5px;">
              <input type="text" id="periode_rawat_jalan" class="form-control periode_rawat_jalan" name="periode_rawat_jalan" required>
            </li>
            <li style="padding-left:5px;padding-right:5px;margin-top:5px;">
              <input type="text" id="periode_rawat_jalan_akhir" class="form-control periode_rawat_jalan" name="periode_rawat_jalan_akhir" required>
            </li>
            <li style="padding-left:5px;padding-right:5px;margin-top:5px;">
              <div id="submit_periode_rawat_jalan" class="btn btn-primary btn-block" style="text-align: left !important;">Semua</div>
            </li>
            <li style="padding-left:5px;padding-right:5px;margin-top:5px;">
              <div id="belum_periode_rawat_jalan" class="btn btn-primary btn-block" style="text-align: left !important;">Belum Diperiksa</div>
            </li>
            <li style="padding-left:5px;padding-right:5px;margin-top:5px;">
              <div id="selesai_periode_rawat_jalan" class="btn btn-primary btn-block" style="text-align: left !important;">Selesai Diperiksa</div>
            </li>
            <li style="padding-left:5px;padding-right:5px;margin-top:5px;">
              <div id="lunas_periode_rawat_jalan" class="btn btn-primary btn-block" style="text-align: left !important;">Sudah Bayar</div>
            </li>
            <li style="padding-left:5px;padding-right:5px;margin-top:5px;">
              <div id="btn_cetak" class="btn btn-primary btn-block" data-toggle="modal" style="text-align: left !important;">Export PDF</div>
            </li>
            <li style="padding-left:5px;padding-right:5px;margin-top:5px;">
              <div class="btn btn-primary btn-block" style="text-align: left !important;"><a href="{?=url([ADMIN,'rawat_jalan','excel'])?}" target="_blank" style="color: #ffffff !important;">Export XLS</a></div>
            </li>
          </ul>
        </div>
        <h3 class="panel-title">Kelola Pasien</h3>
      </div>
      <div class="panel-body">
        <div class="row">
          <div id="notif"></div>
        </div>
        {if: $this->core->getUserInfo('role') == 'admin' || $this->core->getUserInfo('role') == 'rekammedis'}
        {if: $this->core->checkPermission($this->core->getUserInfo('username'), 'can_create', 'rawat_jalan') == true}
        <div class="row">
          <div id="form">
            {include: ../plugins/rawat_jalan/view/admin/form.html}
          </div>
        </div>
        {/if}
        {/if}
        <div id="rawat_jalan" class="display">
          {include: ../plugins/rawat_jalan/view/admin/display.html}
        </div>
        <div class="row">
          {include: ../plugins/rawat_jalan/view/admin/form.rincian.html}
          {include: ../plugins/rawat_jalan/view/admin/form.soap.html}
          {include: ../plugins/rawat_jalan/view/admin/form.berkasdigital.html}
          {include: ../plugins/rawat_jalan/view/admin/form.kontrol.html}
          {if: $cek_vclaim}
            {include: ../plugins/vclaim/view/admin/form.sep.html}
          {/if}
        </div>
        <div>
          <div id="rincian"></div>
          <div id="soap"></div>
          <div id="sep"></div>
          <div id="surat_kontrol"></div>
          <div id="berkasdigital"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
   var currentPage = 1;
   var baseUrl = '{?=url()?}/{?=ADMIN?}/api/rawat_jalan';
   var token = '{?=$_SESSION['token']?}';

   $(function () {
       $('.periode_rawat_jalan').datetimepicker({
         defaultDate: '{?=date('Y-m-d')?}',
         format: 'YYYY-MM-DD',
         locale: 'id'
       });
       
       loadData();

       $('#searchInput').on('keypress', function (e) {
          if(e.which === 13){
              loadData(1);
          }
       });

       $('#submit_periode_rawat_jalan').click(function() {
           loadData(1);
       });
       
       $('#belum_periode_rawat_jalan').click(function() {
           loadData(1, 'belum');
       });
       
       $('#selesai_periode_rawat_jalan').click(function() {
           loadData(1, 'selesai');
       });
       
       $('#lunas_periode_rawat_jalan').click(function() {
           loadData(1, 'lunas');
       });
   });

   function loadData(page = 1, status_periksa = '') {
      currentPage = page;
      var search = $('#searchInput').val();
      var tgl_awal = $('#periode_rawat_jalan').val();
      var tgl_akhir = $('#periode_rawat_jalan_akhir').val();
      
      $.ajax({
          url: baseUrl + '/list',
          method: 'GET',
          data: {
              draw: 1,
              start: (page - 1) * 10,
              length: 10,
              search: { value: search },
              tgl_awal: tgl_awal,
              tgl_akhir: tgl_akhir,
              status_periksa: status_periksa,
              t: token
          },
          success: function(response) {
              console.log(response);
              if(typeof response === 'string') response = JSON.parse(response);
              
              if(response.status === 'error') {
                   $('#tableBody').html('<tr><td colspan="12" class="text-center text-danger">' + response.message + '</td></tr>');
                   return;
              }

              var rows = '';
              if(response.data && response.data.length > 0) {
                  response.data.forEach(function(item) {
                      var bgStyle = item.stts == 'Sudah' ? 'style="background-color: #dff0d8 !important;"' : '';
                      rows += '<tr ' + bgStyle + '>';
                      
                      // Column 1: No RM & Dropdown (Simplified for now, add full dropdown later)
                      rows += '<td style="white-space: nowrap;">';
                      rows += '<span class="dropdown-toggle" data-toggle="dropdown"><button type="button" class="btn btn-sm btn-default">' + item.no_rkm_medis + ' <span class="caret"></span></button></span>';
                      rows += '<ul class="dropdown-menu" role="menu">';
                      // Add menu items here consistent with display.html
                      rows += '<li><a href="#soap" data-no_rawat="' + item.no_rawat + '" data-no_rkm_medis="' + item.no_rkm_medis + '" data-nm_pasien="' + item.nm_pasien + '">SOAPIE & Pemeriksaan</a></li>';
                      rows += '</ul>';
                      rows += '</td>';

                      rows += '<td style="white-space: nowrap;">' + item.nm_pasien + '</td>';
                      rows += '<td>' + item.no_rawat + '</td>';
                      rows += '<td style="white-space: nowrap;"><button class="btn btn-xs btn-warning">' + item.no_reg + '</button></td>';
                      rows += '<td style="white-space: nowrap;">' + item.nm_poli + '</td>';
                      rows += '<td style="white-space: nowrap;">' + item.nm_dokter + '</td>';
                      rows += '<td style="white-space: nowrap;">' + item.png_jawab + '</td>';
                      rows += '<td style="white-space: nowrap;">' + (item.no_peserta || '-') + '</td>';
                      rows += '<td style="white-space: nowrap;">' + item.tgl_registrasi + ' ' + item.jam_reg + '</td>';
                      rows += '<td style="white-space: nowrap;">' + item.stts + '</td>';
                      rows += '<td style="white-space: nowrap;">' + item.status_lanjut + '</td>';
                      rows += '<td style="white-space: nowrap;">' + item.status_bayar + '</td>';
                      
                      rows += '</tr>';
                  });
              } else {
                  rows = '<tr><td colspan="12" class="text-center">Tidak ada data.</td></tr>';
              }
              $('#tableBody').html(rows);
              $('#totalData').text('Jumlah: ' + response.meta.total);
              
              // Pagination
              var totalPages = Math.ceil(response.meta.total / response.meta.per_page);
              var pagination = '';
              
              if(page > 1) {
                  pagination += '<li><a href="#" onclick="loadData(1)">&laquo;</a></li>';
                  pagination += '<li><a href="#" onclick="loadData(' + (page - 1) + ')">‹</a></li>';
              } else {
                  pagination += '<li class="disabled"><a href="#">&laquo;</a></li>';
                  pagination += '<li class="disabled"><a href="#">‹</a></li>';
              }
              
              pagination += '<li class="disabled"><a href="#">Hal : ' + page + ' dari ' + totalPages + ' Hal</a></li>';
              
              if(page < totalPages) {
                  pagination += '<li><a href="#" onclick="loadData(' + (page + 1) + ')">›</a></li>';
                  pagination += '<li><a href="#" onclick="loadData(' + totalPages + ')">&raquo;</a></li>';
              } else {
                  pagination += '<li class="disabled"><a href="#">›</a></li>';
                  pagination += '<li class="disabled"><a href="#">&raquo;</a></li>';
              }
              
              $('#pagination').html(pagination);
          },
          error: function(xhr) {
              console.error(xhr);
              $('#tableBody').html('<tr><td colspan="12" class="text-center text-danger">Gagal memuat data.</td></tr>');
          }
      });
   }
</script>
